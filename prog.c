#include <stdio.h>

int main()
{
    FILE *f = fopen("inpFile.mbin", "wb");
    unsigned char program[] = {
        // 0x4d, 0x49, 0x4e, 0x00, 0x00, 0x00, 0x00, 0x01, /*We are going big endian mode here for easiness*/
        // 0x00, 0x00 ,0x00, 0x00, 0x00, 0x00, 0x00, 0x38, /*The instruction's size*/
        // 0x00, 0x00 ,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*The data size: We have none*/
        // 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, /*xor_reg Mb, Mb*/
        // // 0x1A, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x42, 0x40, /*move_imm Ma, 1000000*/
        // 0x1A, 0x00, 0x00, 0x00, 0x3B, 0x9A, 0xCA, 0x00, /*move_imm Ma, 1000000000*/
        // // 0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, /*move_imm Ma, 5*/
        // 0x3B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, /*cmp_reg Ma, Mb*/
        // 0x3D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*dec Ma*/
        // 0x4E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*jnz [2]*/
        // 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, /*The address to jump to*/
        // 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  /*Halt*/
        0x4d, 0x49, 0x4e, 0x00, 0x00, 0x00, 0x00, 0x00, /*We are going big endian mode here for easiness*/
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, /*The instruction's size*/
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*The data size: We have none*/
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*The string size: We have none*/
        0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, /*xor_reg Mb, Mb*/
        // 0x1A, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x42, 0x40, /*move_imm Ma, 1000000*/
        0x1A, 0x00, 0x00, 0x00, 0x3B, 0x9A, 0xCA, 0x00, /*move_imm Ma, 1000000000*/
        // 0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, /*move_imm Ma, 5*/
        0x3B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, /*cmp_reg Ma, Mb*/
        0x3D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*dec Ma*/
        0x4E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, /*jnz [2]*/
        // 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, /*The address to jump to[We don't need this anymore]*/
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 /*Halt*/
    };
    fwrite(program, 1, sizeof(program), f);
    fclose(f);
}

/*
  Here we are using moves to store the addresses of variables. This might not be likeable to some people but it is possible because we know where in memory is the msg going to be stored
  msg1: "What is your name?\n"
  msg2: "Hello, there "
  msg1_len: 13 ;; 13 bytes consumed by this
  msg2_len: 19 ;; 19 bytes consumed by this
  _name_: db some_len

  main:
    mov_imm Ma, msg1 ;; save the address of msg1
    load Mc, [msg1_len] ;; load the size from memory
 print1_loop1:
    call print
    inc Ma ;; update the address
    loop print_loop1

   mov_imm Ma, _name_ ;; This is where we will store the name
   xor_reg Mf, Mf ;; we will use this to count the number of bytes we read

 read_loop:
    call read
    loadb_reg Md, [Ma] ;; load whatever was read
    cmp_imm Md, 10 ;; see if we read a newline
    je done_reading ;; get out of the loop now

    inc Ma ;; update the address
    inc Mf ;; update the counter
    jmp read_loop

  done_reading:
    ;; now we print the message and the name
    mov_imm Ma, msg2
    load Mc, [msg2_len]
 print1_loop2:
    call print
    inc Ma ;; update the address
    loop print_loop2

    ;; now print the name
    mov_reg Mc, Mf ;; Mf was the counter
    mov_imm Ma, _name_ ;; now reload the address
 print_name:
    call print
    inc Ma
    loop print_name

    mov_imm Ma, 10
    storeb_reg 0, Ma ;; basically write a new line
    mov_imm Ma, 0 ;; the address
    int 158
    halt ;; stop

  print:
    int 158 ;; the print char request
    ret

  read:
    int 154 ;; the read char request
    ret

  0x4d, 0x49, 0x4e, 0x00, 0x00, 0x00, 0x00, 0x00, // The first header bytes
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // The instruction len
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, // The data len
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, // The string len

  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1A, // mov_imm Ma, msg1
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x3F, // load Mc, msg1_len
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, // call print <|
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, // inc Ma      |
  0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5C, // loop 2 -----|
  
  0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1A, // mov_imm Ma, _name_
  0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x36, // xor_reg Mf, Mf\
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, // call read
  0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x68, // loadb_reg Md, Ma
  0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3A, // cmp_imm Md, 10
  0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // the value 10 for comparison
  0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x51, // je done_reading

  0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // the msg1_len
  0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // the msg2_len
  0x57, 0x68, 0x61, 0x74, 0x20, 0x69, 0x73, 0x20, // "What is "
  0x79, 0x6F, 0x75, 0x72, 0x20, 0x6E, 0x61, 0x6D, // "your nam"
  0x65, 0x3F, 0x10, 0x48, 0x65, 0x6C, 0x6C, 0x6F, // "e?\n Hello"
  0x2C, 0x20, 0x74, 0x68, 0x65, 0x72, 0x65, 0x20, // ", there "
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  // the _name_
*/